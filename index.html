<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Schedule Maker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #f5f7ff;
            --text-color: #333;
            --light-gray: #f0f0f0;
            --border-color: #ddd;
            --header-bg: #4a6bff;
            --header-text: white;
            --row-even: #f5f7ff;
            --row-odd: white;
            --error-color: #e63946;
            --success-color: #00c853;
            --container-bg: white;
            --footer-bg: #f8f9fa;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, #e0e7ff, #ffffff);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .wrapper {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            padding: 30px;
            animation: fadeIn 0.5s ease-in;
        }

        footer {
            text-align: center;
            padding: 15px 0;
            color: #555;
            font-size: 14px;
            background: var(--footer-bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        h1::after {
            content: "";
            display: block;
            width: 100px;
            height: 4px;
            background: var(--primary-color);
            margin: 10px auto 0;
            border-radius: 2px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--secondary-color);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            position: relative;
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
            outline: none;
        }

        input.error, select.error {
            border-color: var(--error-color);
            box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .time-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-picker input[type="time"] {
            width: 45%;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        button:hover {
            background-color: #3a5bef;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        button[aria-label]:hover::after {
            content: attr(aria-label);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #clear-btn {
            background-color: #ff4a4a;
        }

        #clear-btn:hover {
            background-color: #e03e3e;
        }

        #export-btn {
            background-color: var(--success-color);
        }

        #export-btn:hover {
            background-color: #00b34a;
        }

        #cancel-btn {
            background-color: #6c757d;
        }

        #cancel-btn:hover {
            background-color: #5a6268;
        }

        #duplicate-btn {
            background-color: #17a2b8;
        }

        #duplicate-btn:hover {
            background-color: #138496;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .schedule-container {
            margin-top: 30px;
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .schedule {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .schedule th {
            background-color: var(--header-bg);
            color: var(--header-text);
            font-weight: 600;
            padding: 15px;
            text-align: left;
            position: sticky;
            top: 0;
            font-size: 15px;
            cursor: pointer;
        }

        .schedule th:hover {
            background-color: #3a5bef;
        }

        .schedule td {
            border: 1px solid var(--border-color);
            padding: 15px;
            text-align: left;
            vertical-align: middle;
            font-size: 14px;
        }

        .schedule tr:nth-child(even) {
            background-color: var(--row-even);
        }

        .schedule tr:nth-child(odd) {
            background-color: var(--row-odd);
        }

        .schedule tr:hover {
            background-color: rgba(74, 107, 255, 0.05);
        }

        .subject-code {
            color: var(--text-color);
            font-size: 15px;
        }

        .delete-btn, .edit-btn, .duplicate-btn {
            cursor: pointer;
            color: #6c757d;
            margin-right: 10px;
            transition: color 0.3s;
        }

        .delete-btn:hover {
            color: #dc3545;
        }

        .edit-btn:hover {
            color: var(--primary-color);
        }

        .duplicate-btn:hover {
            color: #17a2b8;
        }

        .empty-message {
            text-align: center;
            padding: 30px;
            color: #777;
            font-style: italic;
            background-color: var(--secondary-color);
        }

        .template-selector {
            margin: 25px 0;
            padding: 20px;
            background: var(--secondary-color);
            border-radius: 10px;
        }

        .template-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
        }

        .template-option {
            width: 120px;
            height: 100px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            transition: all 0.3s;
        }

        .template-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .template-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.3);
        }

        .template-preview {
            width: 100%;
            height: 70%;
            background-size: cover;
        }

        .template-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 12px;
            text-align: center;
            font-weight: 500;
        }

        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            font-size: 14px;
            font-weight: 500;
        }

        .notification.error {
            background: var(--error-color);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        tr.editing {
            background-color: #fff3cd;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }

            .buttons {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .schedule th, .schedule td {
                padding: 10px;
                font-size: 12px;
            }

            .template-option {
                width: 100px;
                height: 90px;
            }

            footer {
                font-size: 12px;
                padding: 10px 0;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .controls {
                padding: 15px;
            }

            .notification {
                top: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="container">
            <h1><i class="fas fa-calendar-alt" aria-hidden="true"></i> Student Schedule Maker</h1>

            <div class="controls">
                <div class="form-group">
                    <label for="days"><i class="far fa-calendar" aria-hidden="true"></i> Days</label>
                    <select id="days" multiple aria-describedby="days-error">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                    <div class="error-message" id="days-error">Please select at least one day</div>
                </div>

                <div class="form-group">
                    <label for="start-time"><i class="far fa-clock" aria-hidden="true"></i> Time</label>
                    <div class="time-picker">
                        <input type="time" id="start-time" aria-describedby="time-error">
                        <span>-</span>
                        <input type="time" id="end-time" aria-describedby="time-error">
                    </div>
                    <div class="error-message" id="time-error">Please select valid start and end times</div>
                </div>

                <div class="form-group">
                    <label for="subject-code"><i class="fas fa-book" aria-hidden="true"></i> Subject Code</label>
                    <input type="text" id="subject-code" placeholder="ex. - IS 123" aria-describedby="subject-code-error">
                    <div class="error-message" id="subject-code-error">Subject Code is required</div>
                </div>

                <div class="form-group">
                    <label for="subject-name"><i class="fas fa-book-open" aria-hidden="true"></i> Subject Name</label>
                    <input type="text" id="subject-name" placeholder="ex. - Computer Programming" aria-describedby="subject-name-error">
                    <div class="error-message" id="subject-name-error">Subject Name is required</div>
                </div>

                <div class="form-group">
                    <label for="room"><i class="fas fa-door-open" aria-hidden="true"></i> Room</label>
                    <input type="text" id="room" placeholder="ex. - College Comlab">
                </div>

                <div class="form-group">
                    <label for="lecturer"><i class="fas fa-chalkboard-teacher" aria-hidden="true"></i> Lecturer</label>
                    <input type="text" id="lecturer" placeholder="ex. - Eric Mayo">
                </div>
            </div>

            <div class="buttons">
                <button id="add-btn" aria-label="Add or update a subject"><i class="fas fa-plus" aria-hidden="true"></i> Add Subject</button>
                <button id="duplicate-btn" aria-label="Duplicate selected subject" style="display: none;"><i class="fas fa-copy" aria-hidden="true"></i> Duplicate</button>
                <button id="clear-btn" aria-label="Clear all subjects"><i class="fas fa-trash" aria-hidden="true"></i> Clear All</button>
                <button id="sort-btn" aria-label="Sort schedule by day and time"><i class="fas fa-sort" aria-hidden="true"></i> Sort Schedule</button>
                <button id="export-btn" aria-label="Export schedule as image"><i class="fas fa-download" aria-hidden="true"></i> Export as Image</button>
                <button id="export-pdf-btn" aria-label="Export schedule as PDF"><i class="fas fa-file-pdf" aria-hidden="true"></i> Export as PDF</button>
                <button id="cancel-btn" style="display: none;" aria-label="Cancel editing"><i class="fas fa-times" aria-hidden="true"></i> Cancel</button>
            </div>

            <div class="template-selector">
                <h3><i class="fas fa-palette" aria-hidden="true"></i> Select Schedule Template</h3>
                <div class="template-options">
                    <div class="template-option selected" data-template="default" onclick="applyTemplate('default')">
                        <div class="template-preview" style="background: linear-gradient(135deg, #4a6bff, #8a9eff);"></div>
                        <div class="template-name">Default Blue</div>
                    </div>
                    <div class="template-option" data-template="professional" onclick="applyTemplate('professional')">
                        <div class="template-preview" style="background: linear-gradient(135deg, #2c3e50, #34495e);"></div>
                        <div class="template-name">Professional</div>
                    </div>
                    <div class="template-option" data-template="warm" onclick="applyTemplate('warm')">
                        <div class="template-preview" style="background: linear-gradient(135deg, #ff7e5f, #feb47b);"></div>
                        <div class="template-name">Warm Tone</div>
                    </div>
                    <div class="template-option" data-template="green" onclick="applyTemplate('green')">
                        <div class="template-preview" style="background: linear-gradient(135deg, #00b09b, #96c93d);"></div>
                        <div class="template-name">Green Fresh</div>
                    </div>
                    <div class="template-option" data-template="purple" onclick="applyTemplate('purple')">
                        <div class="template-preview" style="background: linear-gradient(135deg, #4776E6, #8E54E9);"></div>
                        <div class="template-name">Purple</div>
                    </div>
                    <div class="template-option" data-template="dark" onclick="applyTemplate('dark')">
                        <div class="template-preview" style="background: linear-gradient(135deg, #121212, #1e1e1e);"></div>
                        <div class="template-name">Dark Mode</div>
                    </div>
                </div>
            </div>

            <div class="schedule-container">
                <table class="schedule" id="schedule-table">
                    <thead>
                        <tr>
                            <th scope="col">Days</th>
                            <th scope="col">Time</th>
                            <th scope="col">Subject Code</th>
                            <th scope="col">Subject Name</th>
                            <th scope="col">Room</th>
                            <th scope="col">Lecturer</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <tr class="empty-message">
                            <td colspan="7">No subjects added yet. Add your first subject above.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="loading-spinner" id="loading-spinner">
                <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Exporting...
            </div>

            <div class="notification" id="notification" role="alert"></div>
        </div>

        <footer>
            ©2025 gmzn_prg | All rights reserved
        </footer>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Initialize variables
        const scheduleBody = document.getElementById('schedule-body');
        const addBtn = document.getElementById('add-btn');
        const duplicateBtn = document.getElementById('duplicate-btn');
        const clearBtn = document.getElementById('clear-btn');
        const sortBtn = document.getElementById('sort-btn');
        const exportBtn = document.getElementById('export-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const notification = document.getElementById('notification');
        let editingRow = null;

        // Load schedule and template on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadScheduleFromStorage();
            const savedTemplate = localStorage.getItem('selectedTemplate') || 'default';
            applyTemplate(savedTemplate);
            document.querySelectorAll('.template-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.template === savedTemplate);
            });
        });

        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.toggle('error', isError);
            notification.style.display = 'block';
            notification.setAttribute('aria-live', isError ? 'assertive' : 'polite');
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Input validation with time conflict check
        function validateInputs() {
            const days = Array.from(document.getElementById('days').selectedOptions).map(opt => opt.value);
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const subjectCode = document.getElementById('subject-code').value.trim();
            const subjectName = document.getElementById('subject-name').value.trim();
            let isValid = true;

            // Days validation
            if (days.length === 0) {
                document.getElementById('days').classList.add('error');
                document.getElementById('days-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('days').classList.remove('error');
                document.getElementById('days-error').style.display = 'none';
            }

            // Time validation
            if (!startTime || !endTime) {
                document.getElementById('start-time').classList.add('error');
                document.getElementById('end-time').classList.add('error');
                document.getElementById('time-error').style.display = 'block';
                isValid = false;
            } else if (startTime >= endTime) {
                document.getElementById('start-time').classList.add('error');
                document.getElementById('end-time').classList.add('error');
                document.getElementById('time-error').textContent = 'End time must be after start time';
                document.getElementById('time-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('start-time').classList.remove('error');
                document.getElementById('end-time').classList.remove('error');
                document.getElementById('time-error').style.display = 'none';
            }

            // Check for time conflicts
            if (isValid && !editingRow) {
                const rows = Array.from(scheduleBody.querySelectorAll('tr:not(.empty-message)'));
                const start = new Date(`1970-01-01T${startTime}:00`);
                const end = new Date(`1970-01-01T${endTime}:00`);
                for (const row of rows) {
                    const rowDays = row.cells[0].textContent.split(', ');
                    const [rowStart, rowEnd] = row.cells[1].textContent.split(' - ').map(parseTime);
                    const rowStartDate = new Date(`1970-01-01T${rowStart}:00`);
                    const rowEndDate = new Date(`1970-01-01T${rowEnd}:00`);
                    const hasConflict = days.some(day => rowDays.includes(day)) &&
                        !(end <= rowStartDate || start >= rowEndDate);
                    if (hasConflict) {
                        document.getElementById('time-error').textContent = 'Time conflict detected for selected day(s)';
                        document.getElementById('time-error').style.display = 'block';
                        document.getElementById('start-time').classList.add('error');
                        document.getElementById('end-time').classList.add('error');
                        isValid = false;
                        break;
                    }
                }
            }

            // Subject Code validation
            if (!subjectCode) {
                document.getElementById('subject-code').classList.add('error');
                document.getElementById('subject-code-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('subject-code').classList.remove('error');
                document.getElementById('subject-code-error').style.display = 'none';
            }

            // Subject Name validation
            if (!subjectName) {
                document.getElementById('subject-name').classList.add('error');
                document.getElementById('subject-name-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('subject-name').classList.remove('error');
                document.getElementById('subject-name-error').style.display = 'none';
            }

            return isValid;
        }

        // Add or update subject
        addBtn.addEventListener('click', () => {
            if (!validateInputs()) return;

            const days = Array.from(document.getElementById('days').selectedOptions).map(opt => opt.value);
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const time = `${formatTime(startTime)} - ${formatTime(endTime)}`;
            const subjectCode = sanitizeInput(document.getElementById('subject-code').value.trim());
            const subjectName = sanitizeInput(document.getElementById('subject-name').value.trim());
            const room = sanitizeInput(document.getElementById('room').value.trim()) || 'TBA';
            const lecturer = sanitizeInput(document.getElementById('lecturer').value.trim()) || 'TBA';

            if (editingRow) {
                editingRow.cells[0].textContent = days.join(', ');
                editingRow.cells[1].textContent = time;
                editingRow.cells[2].innerHTML = `<span class="subject-code">${subjectCode}</span>`;
                editingRow.cells[3].textContent = subjectName;
                editingRow.cells[4].textContent = room;
                editingRow.cells[5].textContent = lecturer;
                editingRow.classList.remove('editing');
                showNotification('Subject updated successfully!');
                editingRow = null;
                addBtn.textContent = 'Add Subject';
                addBtn.setAttribute('aria-label', 'Add or update a subject');
                cancelBtn.style.display = 'none';
                duplicateBtn.style.display = 'none';
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${days.join(', ')}</td>
                    <td>${time}</td>
                    <td><span class="subject-code">${subjectCode}</span></td>
                    <td>${subjectName}</td>
                    <td>${room}</td>
                    <td>${lecturer}</td>
                    <td>
                        <i class="fas fa-edit edit-btn" onclick="editRow(this)" aria-label="Edit subject"></i>
                        <i class="fas fa-copy duplicate-btn" onclick="duplicateRow(this)" aria-label="Duplicate subject"></i>
                        <i class="fas fa-trash delete-btn" onclick="deleteRow(this)" aria-label="Delete subject"></i>
                    </td>
                `;
                scheduleBody.appendChild(row);
                const emptyMessage = document.querySelector('.empty-message');
                if (emptyMessage) emptyMessage.remove();
                showNotification('Subject added successfully!');
            }

            saveScheduleToStorage();
            clearForm();
        });

        // Edit row
        function editRow(btn) {
            if (editingRow) {
                editingRow.classList.remove('editing');
            }
            editingRow = btn.closest('tr');
            editingRow.classList.add('editing');
            const days = editingRow.cells[0].textContent.split(', ');
            const [start, end] = editingRow.cells[1].textContent.split(' - ').map(parseTime);
            document.getElementById('days').querySelectorAll('option').forEach(opt => {
                opt.selected = days.includes(opt.value);
            });
            document.getElementById('start-time').value = start;
            document.getElementById('end-time').value = end;
            document.getElementById('subject-code').value = editingRow.cells[2].textContent;
            document.getElementById('subject-name').value = editingRow.cells[3].textContent;
            document.getElementById('room').value = editingRow.cells[4].textContent === 'TBA' ? '' : editingRow.cells[4].textContent;
            document.getElementById('lecturer').value = editingRow.cells[5].textContent === 'TBA' ? '' : editingRow.cells[5].textContent;
            addBtn.textContent = 'Update Subject';
            addBtn.setAttribute('aria-label', 'Update subject');
            cancelBtn.style.display = 'inline-flex';
            duplicateBtn.style.display = 'inline-flex';
        }

        // Duplicate row
        function duplicateRow(btn) {
            const row = btn.closest('tr');
            const days = row.cells[0].textContent.split(', ');
            const [start, end] = row.cells[1].textContent.split(' - ').map(parseTime);
            document.getElementById('days').querySelectorAll('option').forEach(opt => {
                opt.selected = days.includes(opt.value);
            });
            document.getElementById('start-time').value = start;
            document.getElementById('end-time').value = end;
            document.getElementById('subject-code').value = row.cells[2].textContent;
            document.getElementById('subject-name').value = row.cells[3].textContent;
            document.getElementById('room').value = row.cells[4].textContent === 'TBA' ? '' : row.cells[4].textContent;
            document.getElementById('lecturer').value = row.cells[5].textContent === 'TBA' ? '' : row.cells[5].textContent;
            showNotification('Subject duplicated. Modify and add as needed.');
        }

        // Cancel edit
        cancelBtn.addEventListener('click', () => {
            if (editingRow) {
                editingRow.classList.remove('editing');
                editingRow = null;
            }
            addBtn.textContent = 'Add Subject';
            addBtn.setAttribute('aria-label', 'Add or update a subject');
            cancelBtn.style.display = 'none';
            duplicateBtn.style.display = 'none';
            clearForm();
            showNotification('Editing cancelled');
        });

        // Delete row
        function deleteRow(btn) {
            if (confirm('Are you sure you want to delete this subject?')) {
                btn.closest('tr').remove();
                if (scheduleBody.children.length === 0) {
                    scheduleBody.innerHTML = '<tr class="empty-message"><td colspan="7">No subjects added yet. Add your first subject above.</td></tr>';
                }
                saveScheduleToStorage();
                showNotification('Subject deleted successfully!');
            }
        }

        // Clear all subjects
        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all subjects?')) {
                scheduleBody.innerHTML = '<tr class="empty-message"><td colspan="7">No subjects added yet. Add your first subject above.</td></tr>';
                localStorage.removeItem('schedule');
                clearForm();
                showNotification('All subjects cleared');
            }
        });

        // Sort schedule
        sortBtn.addEventListener('click', () => {
            const rows = Array.from(scheduleBody.querySelectorAll('tr:not(.empty-message)'));
            if (rows.length === 0) {
                showNotification('No subjects to sort.', true);
                return;
            }

            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            rows.sort((a, b) => {
                const aDays = a.cells[0].textContent.split(', ').sort((x, y) => dayOrder.indexOf(x) - dayOrder.indexOf(y))[0];
                const bDays = b.cells[0].textContent.split(', ').sort((x, y) => dayOrder.indexOf(x) - dayOrder.indexOf(y))[0];
                const aTime = new Date(`1970-01-01T${parseTime(a.cells[1].textContent.split(' - ')[0])}:00`);
                const bTime = new Date(`1970-01-01T${parseTime(b.cells[1].textContent.split(' - ')[0])}:00`);
                return dayOrder.indexOf(aDays) - dayOrder.indexOf(bDays) || aTime - bTime;
            });

            scheduleBody.innerHTML = '';
            rows.forEach(row => scheduleBody.appendChild(row));
            saveScheduleToStorage();
            showNotification('Schedule sorted by day and time');
        });

        // Helper functions
        function formatTime(time) {
            const [hour, minute] = time.split(':');
            const h = parseInt(hour);
            const period = h >= 12 ? 'PM' : 'AM';
            const formattedHour = h % 12 || 12;
            return `${formattedHour}:${minute} ${period}`;
        }

        function parseTime(timeStr) {
            const [time, period] = timeStr.split(' ');
            let [hour, minute] = time.split(':');
            hour = parseInt(hour);
            if (period === 'PM' && hour < 12) hour += 12;
            if (period === 'AM' && hour === 12) hour = 0;
            return `${hour.toString().padStart(2, '0')}:${minute}`;
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function clearForm() {
            document.getElementById('days').selectedIndex = -1;
            document.getElementById('start-time').value = '';
            document.getElementById('end-time').value = '';
            document.getElementById('subject-code').value = '';
            document.getElementById('subject-name').value = '';
            document.getElementById('room').value = '';
            document.getElementById('lecturer').value = '';
        }

        // Save schedule to local storage
        function saveScheduleToStorage() {
            const rows = Array.from(scheduleBody.querySelectorAll('tr:not(.empty-message)')).map(row => ({
                days: row.cells[0].textContent,
                time: row.cells[1].textContent,
                subjectCode: row.cells[2].textContent,
                subjectName: row.cells[3].textContent,
                room: row.cells[4].textContent,
                lecturer: row.cells[5].textContent
            }));
            localStorage.setItem('schedule', JSON.stringify(rows));
        }

        // Load schedule from local storage
        function loadScheduleFromStorage() {
            const savedSchedule = localStorage.getItem('schedule');
            if (savedSchedule) {
                const rows = JSON.parse(savedSchedule);
                if (rows.length > 0) {
                    scheduleBody.innerHTML = '';
                    rows.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.days}</td>
                            <td>${row.time}</td>
                            <td><span class="subject-code">${row.subjectCode}</span></td>
                            <td>${row.subjectName}</td>
                            <td>${row.room}</td>
                            <td>${row.lecturer}</td>
                            <td>
                                <i class="fas fa-edit edit-btn" onclick="editRow(this)" aria-label="Edit subject"></i>
                                <i class="fas fa-copy duplicate-btn" onclick="duplicateRow(this)" aria-label="Duplicate subject"></i>
                                <i class="fas fa-trash delete-btn" onclick="deleteRow(this)" aria-label="Delete subject"></i>
                            </td>
                        `;
                        scheduleBody.appendChild(tr);
                    });
                }
            }
        }

        // Prepare table for export
        function prepareExportTable() {
            const tableClone = document.getElementById('schedule-table').cloneNode(true);
            const actionHeader = tableClone.querySelector('th:last-child');
            if (actionHeader) actionHeader.remove();
            tableClone.querySelectorAll('tr').forEach(row => {
                const actionCell = row.querySelector('td:last-child');
                if (actionCell) actionCell.remove();
            });
            return tableClone;
        }

        // Export as image
        exportBtn.addEventListener('click', () => {
            if (scheduleBody.querySelector('.empty-message')) {
                showNotification('No schedule to export. Please add subjects first.', true);
                return;
            }

            loadingSpinner.style.display = 'block';
            exportBtn.disabled = true;

            const exportContainer = document.createElement('div');
            exportContainer.style.background = 'white';
            exportContainer.style.padding = '20px';
            exportContainer.style.borderRadius = '10px';
            exportContainer.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
            exportContainer.style.width = 'fit-content';
            exportContainer.style.margin = '20px';

            const header = document.createElement('h2');
            header.textContent = 'Student Schedule';
            header.style.textAlign = 'center';
            header.style.color = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
            header.style.marginBottom = '20px';
            exportContainer.appendChild(header);

            const tableClone = prepareExportTable();
            tableClone.style.width = '100%';
            exportContainer.appendChild(tableClone);

            const footer = document.createElement('div');
            footer.style.textAlign = 'center';
            footer.style.marginTop = '20px';
            footer.style.color = '#777';
            footer.style.fontSize = '12px';
            footer.innerHTML = `Generated on ${new Date().toLocaleString()} `;
            exportContainer.appendChild(footer);

            document.body.appendChild(exportContainer);

            html2canvas(exportContainer, {
                scale: 3,
                useCORS: true,
                allowTaint: true,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `schedule_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(exportContainer);
                loadingSpinner.style.display = 'none';
                exportBtn.disabled = false;
                showNotification('Schedule exported as image');
            }).catch(() => {
                showNotification('Error exporting schedule. Please try again.', true);
                loadingSpinner.style.display = 'none';
                exportBtn.disabled = false;
            });
        });

        // Export as PDF
        exportPdfBtn.addEventListener('click', () => {
            if (scheduleBody.querySelector('.empty-message')) {
                showNotification('No schedule to export. Please add subjects first.', true);
                return;
            }

            loadingSpinner.style.display = 'block';
            exportPdfBtn.disabled = true;

            const exportContainer = document.createElement('div');
            exportContainer.style.background = 'white';
            exportContainer.style.padding = '20px';
            exportContainer.style.borderRadius = '10px';
            exportContainer.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
            exportContainer.style.width = 'fit-content';
            exportContainer.style.margin = '20px';

            const header = document.createElement('h2');
            header.textContent = 'Student Schedule';
            header.style.textAlign = 'center';
            header.style.color = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
            header.style.marginBottom = '20px';
            exportContainer.appendChild(header);

            const tableClone = prepareExportTable();
            tableClone.style.width = '100%';
            exportContainer.appendChild(tableClone);

            const footer = document.createElement('div');
            footer.style.textAlign = 'center';
            footer.style.marginTop = '20px';
            footer.style.color = '#777';
            footer.style.fontSize = '12px';
            footer.innerHTML = `Generated on ${new Date().toLocaleString()} | 2025 gmzn_prg | All rights reserved`;
            exportContainer.appendChild(footer);

            document.body.appendChild(exportContainer);

            html2canvas(exportContainer, {
                scale: 3,
                useCORS: true,
                allowTaint: true,
                backgroundColor: null
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`schedule_${new Date().toISOString().slice(0, 10)}.pdf`);
                document.body.removeChild(exportContainer);
                loadingSpinner.style.display = 'none';
                exportPdfBtn.disabled = false;
                showNotification('Schedule exported as PDF');
            }).catch(() => {
                showNotification('Error exporting schedule. Please try again.', true);
                loadingSpinner.style.display = 'none';
                exportPdfBtn.disabled = false;
            });
        });

        // Apply template styles
        function applyTemplate(template) {
            document.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.template-option[data-template="${template}"]`).classList.add('selected');

            const root = document.documentElement;
            switch (template) {
                case 'professional':
                    root.style.setProperty('--primary-color', '#2c3e50');
                    root.style.setProperty('--header-bg', '#34495e');
                    root.style.setProperty('--row-even', '#f5f7ff');
                    root.style.setProperty('--row-odd', 'white');
                    root.style.setProperty('--secondary-color', '#ecf0f1');
                    root.style.setProperty('--container-bg', '#ecf0f1');
                    root.style.setProperty('--footer-bg', '#dfe6e9');
                    document.body.style.background = 'linear-gradient(135deg, #e0e7ff, #ffffff)';
                    break;
                case 'warm':
                    root.style.setProperty('--primary-color', '#ff7e5f');
                    root.style.setProperty('--header-bg', '#ff7e5f');
                    root.style.setProperty('--row-even', '#fff5f2');
                    root.style.setProperty('--row-odd', 'white');
                    root.style.setProperty('--secondary-color', '#fff5f2');
                    root.style.setProperty('--container-bg', 'white');
                    root.style.setProperty('--footer-bg', '#fce4e1');
                    document.body.style.background = 'linear-gradient(135deg, #e0e7ff, #ffffff)';
                    break;
                case 'green':
                    root.style.setProperty('--primary-color', '#00b09b');
                    root.style.setProperty('--header-bg', '#00b09b');
                    root.style.setProperty('--row-even', '#f0fff4');
                    root.style.setProperty('--row-odd', 'white');
                    root.style.setProperty('--secondary-color', '#f0fff4');
                    root.style.setProperty('--container-bg', 'white');
                    root.style.setProperty('--footer-bg', '#e6fff5');
                    document.body.style.background = 'linear-gradient(135deg, #e0e7ff, #ffffff)';
                    break;
                case 'purple':
                    root.style.setProperty('--primary-color', '#8E54E9');
                    root.style.setProperty('--header-bg', '#8E54E9');
                    root.style.setProperty('--row-even', '#f9f0ff');
                    root.style.setProperty('--row-odd', 'white');
                    root.style.setProperty('--secondary-color', '#f9f0ff');
                    root.style.setProperty('--container-bg', 'white');
                    root.style.setProperty('--footer-bg', '#f0e7ff');
                    document.body.style.background = 'linear-gradient(135deg, #e0e7ff, #ffffff)';
                    break;
                case 'dark':
                    root.style.setProperty('--primary-color', '#bb86fc');
                    root.style.setProperty('--header-bg', '#1e1e1e');
                    root.style.setProperty('--row-even', '#2d2d2d');
                    root.style.setProperty('--row-odd', '#121212');
                    root.style.setProperty('--secondary-color', '#2d2d2d');
                    root.style.setProperty('--text-color', '#e0e0e0');
                    root.style.setProperty('--border-color', '#444');
                    root.style.setProperty('--container-bg', '#1e1e1e');
                    root.style.setProperty('--footer-bg', '#2d2d2d');
                    document.body.style.background = 'linear-gradient(135deg, #121212, #1e1e1e)';
                    break;
                default:
                    root.style.setProperty('--primary-color', '#4a6bff');
                    root.style.setProperty('--header-bg', '#4a6bff');
                    root.style.setProperty('--row-even', '#f5f7ff');
                    root.style.setProperty('--row-odd', 'white');
                    root.style.setProperty('--secondary-color', '#f5f7ff');
                    root.style.setProperty('--container-bg', 'white');
                    root.style.setProperty('--footer-bg', '#f8f9fa');
                    document.body.style.background = 'linear-gradient(135deg, #e0e7ff, #ffffff)';
            }
            localStorage.setItem('selectedTemplate', template);
        }
    </script>
</body>
</html>
